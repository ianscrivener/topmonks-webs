<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <meta http-equiv="Accept-CH" content="DPR,Viewport-Width,Width,Save-Data"/>
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,viewport-fit=cover"
  />
  <title>Hlídačshopů.cz</title>
  <link rel="manifest" href="/site.webmanifest">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
  <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
  <!-- Google Tag Manager -->
  <script>(function(w, d, s, l, i) {
      w[l] = w[l] || [];
      w[l].push({
        "gtm.start":
          new Date().getTime(), event: "gtm.js"
      });
      var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s), dl = l != "dataLayer" ? "&l=" + l : "";
      j.async = true;
      j.src =
        "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
      f.parentNode.insertBefore(j, f);
    })(window, document, "script", "dataLayer", "GTM-58WNT3B");</script>
  <!-- End Google Tag Manager -->
</head>
<body class="mdc-typography">
<!-- Google Tag Manager (noscript) -->
<noscript>
  <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-58WNT3B"
          height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>
<!-- End Google Tag Manager (noscript) -->
<div id="app-root" class="mdc-layout-grid">
  <div class="mdc-layout-grid__inner">
    <div class="mdc-layout-grid__cell">
      <form>
        <p><label for="url-field">Zadejte adresu stránky s detailem produktu:</label></p>
        <div>
          <i class="material-icons" tabindex="0" role="button">search</i>
          <input type="url" name="url" id="url-field" required placeholder="https://www.&hellip;">
        </div>
        <button type="submit">Ověřit vývoj ceny</button>
      </form>
    </div>
    <div class="mdc-layout-grid__cell"></div>
  </div>
</div>
<script type="module">
  import { html, svg, render } from "https://unpkg.com/lit-html@1.1.1/lit-html.js?module";

  const root = document.getElementById("app-root");
  const form = document.getElementById("compare-form");
  const chart = () => document.getElementById("hlidac-shopu-chart");
  const apiUrl = detailUri => `https://api.hlidacshopu.cz/shop?url=${encodeURIComponent(detailUri)}&metadata=1`;
  const meta = ({ itemImage, itemName, real_sale, ...rest }) => ({
    name: itemName,
    imageUrl: itemImage === "null" ? null : itemImage,
    realDiscount: real_sale === "null" ? null : parseFloat(real_sale) / 100,
    ...rest
  });
  const formatMoney = x => x.toLocaleString("cs", {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).replace(/,00/g, ",-");
  const formatPercents = x => `${Math.round(100 * x).toLocaleString("cs")} %`;
  const timeout = ms => new Promise((_, reject) => setTimeout(() => reject(new Error("timeout")), ms));
  const shops = new Map([
    ["alza", { name: "Alza", logo: "alza_logo", url: "https://www.alza.cz/", viewBox: "0 0 60 19" }],
    ["czc", { name: "CZC.CZ", logo: "czc.cz_logo", url: "https://www.czc.cz/", viewBox: "0 0 55 13" }],
    ["datart", { name: "Datart", logo: "datart_logo", url: "https://www.datart.cz/", viewBox: "0 0 98 13" }],
    ["itesco", { name: "iTesco", logo: "tesco_logo", url: "https://www.itesco.cz/", viewBox: "0 0 55 18" }],
    ["kasa", { name: "kasa.cz", logo: "kasa_logo", url: "https://www.kasa.cz/", viewBox: "0 0 70 18" }],
    ["kosik", { name: "Košík.cz", logo: "kosik_logo", url: "https://www.kosik.cz/", viewBox: "0 0 71 22" }],
    ["lekarna", { name: "Lékárna.cz", logo: "lekarna_logo", url: "https://www.lekarna.cz/", viewBox: "0 0 79 20" }],
    ["mall", { name: "Mall.cz", logo: "mall_logo", url: "https://www.mall.cz/", viewBox: "0 0 68 19" }],
    ["mironet", { name: "Mironet", logo: "mironet_logo", url: "https://www.mironet.cz/", viewBox: "0 0 59 20" }],
    ["mountfield", {
      name: "Mountfield",
      logo: "mountfield_logo",
      url: "https://www.mountfield.cz/",
      viewBox: "0 0 64 11"
    }],
    ["notino", { name: "Notino", logo: "notino_logo", url: "https://www.notino.cz/", viewBox: "0 0 68 13" }],
    ["rohlik", { name: "Rohlík.cz", logo: "rohlik_logo", url: "https://www.rohlik.cz/", viewBox: "0 0 51 28" }],
    ["tsbohemia", {
      name: "TSBohemia",
      logo: "tsbohemia_logo",
      url: "https://www.tsbohemia.cz/",
      viewBox: "0 0 115 15"
    }]
  ]);

  addEventListener("DOMContentLoaded", async () => {
    console.group("Hlídačshopů.cz");
    const sharedInfo = getSharedInfo(location);
    console.log("Received data:", sharedInfo);
    if (sharedInfo) {
      renderResultsModal(sharedInfo.targetURL);
    }
    console.groupEnd();
  });

  function getTargetURL(searchParams) {
    const targetURL = searchParams.get("url") || searchParams.get("text");
    return targetURL && targetURL.trim().split(" ").pop();
  }

  function getShop(targetURL) {
    if (!targetURL) return null;
    const shop = targetURL.split(".");
    shop.pop();
    return shop.pop();
  }

  function getSharedInfo(location) {
    const { searchParams } = new URL(location);
    const targetURL = getTargetURL(searchParams);
    const title = searchParams.get("title");
    const shop = getShop(targetURL);
    return targetURL && { title, targetURL, shop };
  }

  async function fetchDataSet(detailUri) {
    const resp = await Promise.race([timeout(4000), fetch(apiUrl(detailUri))]);
    if (!resp.ok) throw new Error("API error");
    const { data, metadata } = await resp.json();
    return {
      meta: meta(metadata),
      data: createDataset(data)
    };
  }

  async function renderResultsModal(detailUrl) {
    render(loaderTemplate(), root);
    try {
      const [{ plot }, chartData] = await Promise.all([
        import("https://cdn.jsdelivr.net/npm/chart.js@2.9.1/dist/Chart.bundle.min.js")
          .then(() => import("/assets/js/extension.js")),
        fetchDataSet(detailUrl)
      ]);
      render(resultTemplate(templateData(detailUrl, chartData)), root);
      plot(chart(), chartData);
    } catch (ex) {
      console.error(ex);
      render(notFoundTemplate(), root);
    }
  }

  const parseTime = s => {
    const d = new Date(s);
    d.setHours(0, 0, 0, 0);
    return d;
  };

  function* daysBetween(start, end) {
    const startDay = parseTime(start);
    const endDay = parseTime(end);
    for (const d = startDay; d <= endDay; d.setDate(d.getDate() + 1)) {
      yield new Date(d.getTime());
    }
  }

  function createDataset(data) {
    if (typeof data === "string") {
      data = JSON.parse(data);
    }
    const dataMap = new Map(data.map(x => [parseTime(x.d).getTime(), x]));
    let lastDay = data[0];
    const days = Array.from(
      daysBetween(parseTime(data[0].d), parseTime(data[data.length - 1].d))
    );
    const originalPrice = new Array(days.length);
    const currentPrice = new Array(days.length);
    for (let i = 0, l = days.length; i < l; i++) {
      const day = days[i];
      const item = dataMap.get(day.getTime()) || lastDay;
      lastDay = item;
      originalPrice[i] = { x: day, y: item.o === "" ? null : parseInt(item.o) };
      currentPrice[i] = { x: day, y: item.c === "" ? null : parseInt(item.c) };
    }
    return {
      originalPrice,
      currentPrice
    };
  }

  function naiveDiscount(currentPrice, actualPrice) {
    const origPrice = currentPrice
      .map(x => x.y)
      .filter(y => y)
      .shift();
    return (origPrice - actualPrice) / origPrice;
  }

  function templateData(
    detailUrl,
    {
      meta: { shop, name, imageUrl, realDiscount },
      data: { currentPrice, originalPrice }
    }
  ) {
    const lastDeclaredPrice = originalPrice
      .map(x => x.y)
      .filter(y => y)
      .pop();
    const { y: actualPrice, x: date } = currentPrice.filter(({ y }) => y).pop();
    const discount =
      realDiscount === null
        ? naiveDiscount(currentPrice, actualPrice)
        : realDiscount;
    return {
      detailUrl,
      name,
      shop,
      imageUrl,
      discount,
      actualPrice,
      date,
      lastDeclaredPrice
    };
  }

  function notFoundTemplate() {
    return html`
      <div id="hlidac-shopu-modal__not-found" class="result mdc-layout-grid__inner">
        <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12">
          <h2>Nenalezeno</h2>
        </div>
        <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12 box box--purple">
          <p>Je nám líto, ale hledaný produkt nebo e-shop nemáme v naší databázi.</p>
        </div>
      </div>
    `;
  }

  function loaderTemplate() {
    return html`
      <div id="hlidac-shopu-modal__loader" class="result mdc-layout-grid__inner">
        <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12">
          <h2>Ověřuji&hellip;</h2>
        </div>
        <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12 box box--purple">
          <div class=loading-container>
            <div class=loader aria-label="Načítám data…">Váš požadavek se zpracovává&hellip;</div>
          </div>
        </div>
      </div>
    `;
  }

  function resultTemplate({ detailUrl, name, shop, lastDeclaredPrice, actualPrice, discount, date }) {
    const declaredOriginalPrice = x => x && html`<div class="claimed-price">Uváděná původní cena <del id="original-price">${formatMoney(x)}</del></div>`;
    const realDiscount = x => x !== null && !isNaN(x) && html`
      <div>
        <abbr title="Reálná sleva se počítá jako aktuální cena po slevě ku maximální ceně, za kterou se zboží prodávalo za posledních 90 dní.">Reálná sleva*</abbr>
        <b class="discount"><span id="real-discount">${formatPercents(x)}</span></b>
      </div>
    `;
    const crawlDate = x => x && html`
      <time id="latest-date"
            datetime="${x.toISOString()}">
        ${x.toLocaleString("cs", {
      day: "numeric",
      month: "long",
      year: "numeric"
    })}
      </time>
    `;
    const shopLogo = x => x && logoTemplate(x);
    return html`
      <div id="hlidac-shopu-modal__found" class="result mdc-layout-grid__inner">
        <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12">
          <h2>${shopLogo(shops.get(shop))}<a href="${detailUrl}" id="product-name">${name || "Vámi vybraný produkt"}</a></h2>
        </div>
        <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12 box box--purple">
          ${crawlDate(date)}
          ${declaredOriginalPrice(lastDeclaredPrice)}
          <div class="actual-price">Prodejní cena <span id="current-price">${formatMoney(actualPrice)}</span></div>
          ${realDiscount(discount) || ""}
        </div>
        <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12">
          <canvas id="hlidac-shopu-chart" width="100%"></canvas>
        </div>
        <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12">
          <div style="display:flex;justify-content: flex-end">
            <div style="width:12px;height:12px;background-color:#5c62cd;border-radius:2px;margin-right:5px;margin-top:2px;"></div>
            <span>Uváděná původní cena</span>
            <div style="width:12px;height:12px;background-color:#ff8787;border-radius:2px;margin: 2px 5px 0 8px;"></div>
            <span>Prodejní cena</span>
          </div>
        </div>
      </div>
    `;
  }

  function logoTemplate({ logo, name, url, viewBox }) {
    const image = svg`
      <svg viewBox="${viewBox}">
        <title>${name}</title>
        <use href="/assets/img/icons.svg#${logo}"/>
      </svg>
    `;
    return html`<a href="${url}" class='sprite sprite--${logo}' title="${name}">${image}</a>`;
  }
</script>
<script type="module">
  import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/4.0.0/workbox-window.prod.mjs";

  if ("serviceWorker" in navigator) {
    const wb = new Workbox("/sw.js");

    wb.register();
  }
</script>

</body>
</html>
